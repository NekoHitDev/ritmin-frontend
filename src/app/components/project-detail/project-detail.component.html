<ng-container *ngIf="project; else noProject">
  <div class="p-d-flex p-flex-column">

    <div class="p-d-flex p-flex-row p-flex-wrap">
      <p-panel header="Details" [toggleable]="true">
        <p-table [value]="[1]">
          <ng-template pTemplate="caption">
            <div class="p-d-flex p-ai-center p-jc-end" *ngIf="walletService.getAddress$().getValue() != null">

              <ng-container *ngIf="isOwner">
                <button pButton type="button" label="Pay Stake" icon="pi pi-send" (click)="payStake()"
                        [disabled]="project.status !== 'PENDING'"></button>
                <button pButton type="button" label="Update" icon="pi pi-upload"
                        [disabled]="project.status !== 'ONGOING' || updatableMilestones.length == 0"
                        (click)="displayUpdate = true"></button>
                <button pButton type="button" label="Finish" icon="pi pi-check"
                        [disabled]="project.status !== 'ONGOING'"
                        (click)="requestFinish()"></button>
                <button pButton type="button" label="Cancel" icon="pi pi-check"
                        [disabled]="project.status !== 'PENDING' && (project.status !== 'ONGOING' || project.stage !== 'Open')"
                        (click)="requestCancel()"></button>
              </ng-container>

              <ng-container *ngIf="!isOwner" class="p-fluid">
                <button pButton type="button" label="Refund" icon="pi pi-undo" [disabled]="purchasedAmount === 0"
                        (click)="makeRefund()"></button>
                <button pButton type="button" label="Purchase" icon="pi pi-shopping-cart"
                        [disabled]="project.status !== 'ONGOING' || project.stage === 'Ready-To-Finish'"
                        (click)="displayPurchase = true"></button>
                <button pButton type="button" label="Request Finish" icon="pi pi-times"
                        *ngIf="project.status === 'ONGOING' && project.stage === 'Ready-To-Finish'"
                        (click)="requestFinish()"></button>
              </ng-container>
            </div>
          </ng-template>
          <ng-template pTemplate="body">
            <tr *ngIf="walletService.getAddress$().getValue() != null && purchasedAmount !== 0">
              <td colspan="2" class="purchasedRow p-text-center">
                    <span class="p-text-bold p-text-center">You have purchased {{purchasedAmount}}
                      {{tokenSymbol}} for this project</span>
              </td>
            </tr>
            <tr>
              <td>Status</td>
              <td>
                <p-tag [value]="project.status" [severity]="getStatusTag(project.status)"></p-tag>
              </td>
            </tr>
            <tr *ngIf="project.stage != null">
              <td>Stage</td>
              <td>
                <p-tag [value]="project.stage" [severity]="getStatusTag(project.stage)"></p-tag>
              </td>
            </tr>
            <tr>
              <td>Creator</td>
              <td><a [href]="'https://neo3.neotube.io/address/' + project.creator">{{project.creator}}</a></td>
            </tr>

            <tr>
              <td>Created at</td>
              <td>{{project.creationTimestamp.toLocaleString()}}</td>
            </tr>
            <tr>
              <td>Identifier</td>
              <td>{{project.identifier}}</td>
            </tr>
            <tr>
              <td>Description</td>
              <td>{{project.description}}</td>
            </tr>
            <tr>
              <td>Cooldown Interval</td>
              <td>{{project.coolDownInterval | timeDuration}}</td>
            </tr>
            <tr>
              <td>Token contract</td>
              <td><a [href]="'https://neo3.testnet.neotube.io/tokens/nep17/0x' + project.tokenHash" target="_blank">
                {{ tokenSymbol }} (0x{{project.tokenHash}})
              </a></td>
            </tr>
            <tr>
            <tr>
              <td>Tokens to sell</td>
              <td>{{project.maxTokenSoldCount}}</td>
            </tr>
            <tr>
              <td>Tokens remaining</td>
              <td>{{project.remainTokenCount}}</td>
            </tr>
            <tr>
              <td>Total milestones</td>
              <td>{{project.milestonesCount}}</td>
            </tr>
            <tr>
              <td>Stake/Token</td>
              <td>{{project.stakeRate100}}</td>
            </tr>
            <tr>
              <td>Last update</td>
              <td>{{project.lastUpdateTimestamp == null ? "Never" : (project.lastUpdateTimestamp | date: 'medium')}}</td>
            </tr>
          </ng-template>
        </p-table>
      </p-panel>
    </div>
    <p-panel header="Milestones" [toggleable]="true" class="p-mt-4">
      <p-table [value]="project.milestones" [autoLayout]="true">
        <ng-template pTemplate="header">
          <tr>
            <th>#</th>
            <th>Title</th>
            <th>Description</th>
            <th>Status</th>
            <th>End Date</th>
            <th>Link to result</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-ms>
          <tr [ngClass]="getMilestoneRowClass(ms)">
            <td>{{getIndex(ms.endTimestamp) + 1}}</td>
            <td>{{ms.title}}</td>
            <td>{{ms.description }}</td>
            <th>
              <p-tag [value]="getStatusTextForMs(ms)" [severity]="getStatusTagForMs(ms)"></p-tag>
            </th>
            <td>{{ms.endTimestamp | date: 'medium'}}</td>
            <td><a [href]="ms.linkToResult">{{ms.linkToResult}}</a></td>
          </tr>
        </ng-template>
      </p-table>
    </p-panel>
  </div>
</ng-container>

<ng-template #noProject>
  <p-progressSpinner [style]="{width: '70px', height: '70px'}"></p-progressSpinner>
</ng-template>


<div class="p-d-flex p-flex-row p-jc-around p-flex-wrap">
  <p-dialog header="Purchase project" [(visible)]="displayPurchase">
    <h4>Set your purchase amount:</h4>
    <p-inputNumber [(ngModel)]="purchaseAmount" [minFractionDigits]="tokenDecimals"
                   [maxFractionDigits]="tokenDecimals" [min]="0.0"></p-inputNumber>
    <button pButton icon="pi pi-plus" label="Purchase" (click)="purchase()"></button>
  </p-dialog>

  <app-pending-request [display]="displayPendingRequest"></app-pending-request>

  <p-confirmDialog appendTo="body" [style]="{width: '50vw'}" [baseZIndex]="1000"
                   rejectButtonStyleClass="p-button-text"></p-confirmDialog>

  <p-dialog header="Update project" [(visible)]="displayUpdate">
    <h4>Select the milestone you want to finish:</h4>
    <div class="p-fluid">
      <p-dropdown [(ngModel)]="selectedMilestone" [options]="updatableMilestones" optionLabel="title"></p-dropdown>
    </div>
    <p><small>The deadline of this milestone is at {{selectedMilestone?.endTime| date: 'medium'}}</small></p>
    <br/>
    <h4>Proof of work:</h4>
    <p><small>
      It is required to post proof of work when finishing a milestone
      so your supporters can take a look and see the progress
      for themselves.
    </small></p>
    <div class="p-fluid">
      <input pInputText [(ngModel)]="proofLink" placeholder="www.link-to-your-proof.com">
    </div>
    <br/>
    <div class="p-text-right">
      <button pButton icon="pi pi-arrow-circle-up" label="Update" (click)="update()"
              [disabled]="proofLink?.length === 0"></button>
    </div>
  </p-dialog>
</div>
