<div class="p-d-flex p-flex-row p-jc-around p-flex-wrap">

  <p-card *ngIf="wca != null">
    <ng-template pTemplate="title">
      {{wca.identifier}}
    </ng-template>
    <ng-template pTemplate="subtitle">
      <p>By <a [href]="'https://neo3.neotube.io/address/' + wca.creator">{{wca.creator}}</a></p>
      <p>At {{wca.creationTimestamp.toLocaleString()}}</p>
    </ng-template>
    <p>Description: {{wca.description}}</p>
    <p>Stake rate: {{wca.stakePer100Token}}CAT</p>
    <p>Total amount: {{wca.maxTokenSoldCount}} CAT</p>
    <p>Remain amount: {{wca.remainTokenCount}} CAT</p>
    <p>Buyer count: {{wca.buyerCount}}</p>
    <p>Total milestone count: {{wca.milestonesCount}}</p>
    <p>Cool down interval: {{wca.coolDownInterval | timeDuration}}</p>
    <p>Last
      update: {{wca.lastUpdateTimestamp == null ? "Never" : wca.lastUpdateTimestamp.toLocaleString()}}</p>
    <p>Current status: {{wca.status}}</p>

    <p style="font-weight: bold" *ngIf="purchasedAmount != 0">You have purchased {{purchasedAmount}}CAT</p>

    <ng-template pTemplate="footer">
      <div class="p-d-flex p-jc-center p-ai-center p-mb-2">
        <button pButton type="button" label="Pay Stake"
                icon="pi pi-money-bill" class="p-button-outlined"
                (click)="payStake()"
                *ngIf="wca.status == 'PENDING' && isOwner"
        ></button>
        <button pButton type="button" label="Purchase"
                icon="pi pi-shopping-cart" class="p-button-outlined"
                *ngIf="wca.status == 'OPEN' && !isOwner"
                (click)="displayPurchase = true"
        ></button>
        <button pButton type="button" label="Refund"
                icon="pi pi-times" class="p-button-outlined"
                *ngIf="purchasedAmount != 0"
                (click)="makeRefund()"
        ></button>
        <button pButton type="button" label="Update"
                icon="pi pi-arrow-circle-up" class="p-button-outlined"
                *ngIf="(wca.status == 'OPEN' || wca.status == 'ACTIVE') && isOwner"
                (click)="displayUpdate = true"
        ></button>
        <button pButton type="button" label="Finish"
                icon="pi pi-times" class="p-button-outlined"
                *ngIf="(wca.status == 'OPEN' || wca.status == 'ACTIVE') && isOwner"
                (click)="requestFinish()"
        ></button>
        <!-- Last milestone is expired and not finished, then anyone can finish -->
        <button pButton type="button" label="Request Finish"
                icon="pi pi-times" class="p-button-outlined"
                *ngIf="wca.milestones[wca.milestones.length - 1].endTimestamp < now
                && wca.status == 'ACTIVE' && !isOwner"
                (click)="requestFinish()"
        ></button>
      </div>
    </ng-template>
  </p-card>

  <div *ngIf="wca != null">
    <h2>Milestones: </h2>
    <div class="p-d-flex p-flex-column">
      <p-card *ngFor="let ms of wca.milestones; let i = index" [attr.data-index]="i">
        <ng-template pTemplate="title">
          <i *ngIf="i == wca.nextMilestone" class="pi pi-arrow-right"></i>
          {{ms.title}}
          <i *ngIf="i == wca.thresholdMilestoneIndex" class="pi pi-star"></i>
          <i *ngIf="ms.linkToResult != null" class="pi pi-check"></i>
          <i *ngIf="ms.endTimestamp <= now" class="pi pi-times"></i>
        </ng-template>
        <ng-template pTemplate="subtitle">
          <p>Deadline: {{ms.endTimestamp.toLocaleString()}}</p>
        </ng-template>
        {{ms.description}}
        <ng-template pTemplate="footer" *ngIf="ms.linkToResult != null">
          <p>Result of this milestone:</p>
          <p>{{ms.linkToResult}}</p>
        </ng-template>
      </p-card>
    </div>
  </div>
</div>

<p-dialog header="Purchase WCA" [(visible)]="displayPurchase">
  <h4>Set your purchase amount:</h4>
  <p-inputNumber [(ngModel)]="purchaseAmount" [minFractionDigits]="2" [min]="0.01"></p-inputNumber>
  <button pButton icon="pi pi-plus" label="Purchase" (click)="purchase()" [disabled]="isLoading"></button>
</p-dialog>

<app-pending-request [display]="displayPendingRequest">

<p-confirmDialog appendTo="body" [style]="{width: '50vw'}" [baseZIndex]="1000" rejectButtonStyleClass="p-button-text"></p-confirmDialog>

<p-dialog header="Update milestone" [(visible)]="displayUpdate">
  <ng-container *ngIf="isLoading">
    <div class="p-d-flex p-jc-center p-ai-center p-flex-column">
      <p-progressSpinner></p-progressSpinner>
      <div class="p-mt-2">
        <small>Please approve the pending request</small>
      </div>
    </div>
  </ng-container>
  <h4>Choose a milestone to update:</h4>
  <p-dropdown [options]="updatableMilestones" [(ngModel)]="selectedMilestones" optionLabel="title"></p-dropdown>
  <br/>
  <small *ngIf="selectedMilestones != undefined">Deadline: {{selectedMilestones.endTime.toLocaleString()}}</small>
  <h4>Proof of your work:</h4>
  <textarea rows="5" cols="30" pInputTextarea [(ngModel)]="updateContent"></textarea>
  <br/>
  <button pButton icon="pi pi-arrow-circle-up" label="Update" (click)="update()" [disabled]="isLoading"></button>
</p-dialog>
